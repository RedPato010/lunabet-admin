<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin LunaBet - Cargas y Retiros</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: white;
    margin: 0;
    padding: 20px;
  }
  h1 {
    color: #ff3333;
    margin-bottom: 10px;
  }
  section {
    margin-bottom: 40px;
  }
  label {
    margin-right: 10px;
  }
  input[type="date"] {
    margin-right: 20px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #444;
    padding: 10px;
    text-align: left;
  }
  th {
    background: #222;
  }
  button {
    background: #ff3333;
    border: none;
    color: white;
    padding: 6px 12px;
    margin-right: 6px;
    cursor: pointer;
    border-radius: 4px;
  }
  button:hover {
    background: #cc2929;
  }
  /* Modal Styles */
  .modal-bg {
    display: flex;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  .modal {
    background: #222;
    padding: 30px 40px;
    border-radius: 10px;
    width: 320px;
    box-shadow: 0 0 15px #ff3333;
    color: white;
  }
  .modal h2 {
    margin-top: 0;
    margin-bottom: 20px;
    text-align: center;
  }
  .modal input {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 6px;
    border: none;
    font-size: 16px;
    outline: none;
  }
  .modal button {
    width: 100%;
    padding: 12px;
    font-size: 18px;
  }
  .error-msg {
    color: #ff6666;
    margin-bottom: 10px;
    text-align: center;
  }
</style>
</head>
<body>

<h1>Panel de Administración - LunaBet</h1>

<section id="seccionCargas" style="display:none;">
  <h2>Cargas Pendientes</h2>
  <label>Desde: <input type="date" id="fechaInicioCarga" /></label>
  <label>Hasta: <input type="date" id="fechaFinCarga" /></label>
  <button id="btnFiltrarCargas">Filtrar</button>

  <table id="tablaCargas">
    <thead>
      <tr>
        <th>Email</th>
        <th>UID</th>
        <th>Monto</th>
        <th>Fecha</th>
        <th>Saldo Actual</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="seccionRetiros" style="display:none;">
  <h2>Retiros Pendientes</h2>
  <label>Desde: <input type="date" id="fechaInicioRetiro" /></label>
  <label>Hasta: <input type="date" id="fechaFinRetiro" /></label>
  <button id="btnFiltrarRetiros">Filtrar</button>

  <table id="tablaRetiros">
    <thead>
      <tr>
        <th>Email</th>
        <th>UID</th>
        <th>Monto</th>
        <th>Alias/CBU</th>
        <th>Fecha</th>
        <th>Saldo Actual</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<button id="btnLogout" style="display:none; margin-bottom: 20px; background:#cc2929;">Cerrar sesión</button>

<!-- Modal Login -->
<div class="modal-bg" id="modalLogin">
  <div class="modal">
    <h2>Ingreso Admin LunaBet</h2>
    <input type="email" id="inputEmail" placeholder="Correo electrónico" />
    <input type="password" id="inputPassword" placeholder="Contraseña" />
    <div class="error-msg" id="loginError"></div>
    <button id="btnLogin">Iniciar sesión</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBDWxn28oXn04--DMwkzqMq00g_W-OYJ3g",
    authDomain: "lunabet-73609.firebaseapp.com",
    projectId: "lunabet-73609",
    storageBucket: "lunabet-73609.appspot.com",
    messagingSenderId: "45582135337",
    appId: "1:45582135337:web:3cb9190e37827d9cc72c38",
    measurementId: "G-0XC4PX3HK9"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const UID_ADMIN = "keVqWPJpBvRZxtb5YjmXSPYM4Aa2";

  const modalLogin = document.getElementById("modalLogin");
  const btnLogin = document.getElementById("btnLogin");
  const loginError = document.getElementById("loginError");
  const inputEmail = document.getElementById("inputEmail");
  const inputPassword = document.getElementById("inputPassword");

  const seccionCargas = document.getElementById("seccionCargas");
  const seccionRetiros = document.getElementById("seccionRetiros");
  const btnLogout = document.getElementById("btnLogout");

  // Función para formatear fecha legible
  function formatearFecha(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    return date.toLocaleString();
  }

  async function obtenerSaldoUsuario(uid) {
    try {
      const doc = await db.collection('users').doc(uid).get();
      if(doc.exists) {
        return doc.data().saldoARS || 0;
      }
      return 0;
    } catch(e) {
      console.error("Error obtener saldo usuario:", e);
      return 0;
    }
  }

  async function cargarCargasPendientes(fechaInicio=null, fechaFin=null) {
    let query = db.collection('cargas').where('estado', '==', 'pendiente');
    if(fechaInicio) query = query.where('creado', '>=', fechaInicio);
    if(fechaFin) query = query.where('creado', '<=', fechaFin);
    query = query.orderBy('creado', 'desc');

    const snapshot = await query.get();
    const tbody = document.querySelector('#tablaCargas tbody');
    tbody.innerHTML = '';

    for(const doc of snapshot.docs) {
      const data = doc.data();
      const saldo = await obtenerSaldoUsuario(data.uid);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.email}</td>
        <td>${data.uid}</td>
        <td>$${data.monto}</td>
        <td>${formatearFecha(data.creado)}</td>
        <td>$${saldo}</td>
        <td>
          <button onclick="aprobarCarga('${doc.id}', '${data.uid}', ${data.monto})">Aprobar</button>
          <button onclick="rechazarCarga('${doc.id}')">Rechazar</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function cargarRetirosPendientes(fechaInicio=null, fechaFin=null) {
    let query = db.collection('retiros').where('estado', '==', 'pendiente');
    if(fechaInicio) query = query.where('creado', '>=', fechaInicio);
    if(fechaFin) query = query.where('creado', '<=', fechaFin);
    query = query.orderBy('creado', 'desc');

    const snapshot = await query.get();
    const tbody = document.querySelector('#tablaRetiros tbody');
    tbody.innerHTML = '';

    for(const doc of snapshot.docs) {
      const data = doc.data();
      const saldo = await obtenerSaldoUsuario(data.uid);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.email}</td>
        <td>${data.uid}</td>
        <td>$${data.monto}</td>
        <td>${data.alias}</td>
        <td>${formatearFecha(data.creado)}</td>
        <td>$${saldo}</td>
        <td>
          <button onclick="aprobarRetiro('${doc.id}', '${data.uid}', ${data.monto})">Aprobar</button>
          <button onclick="rechazarRetiro('${doc.id}')">Rechazar</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function aprobarCarga(cargaId, uid, monto) {
    try {
      const userRef = db.collection('users').doc(uid);
      const userDoc = await userRef.get();
      if(!userDoc.exists) {
        alert("Usuario no encontrado");
        return;
      }
      const saldoActual = userDoc.data().saldoARS || 0;
      await userRef.update({ saldoARS: saldoActual + monto });
      await db.collection('cargas').doc(cargaId).update({ estado: 'aprobado' });
      alert("Carga aprobada y saldo actualizado.");
      cargarCargasPendientes();
    } catch(e) {
      console.error(e);
      alert("Error al aprobar carga.");
    }
  }

  async function rechazarCarga(cargaId) {
    try {
      await db.collection('cargas').doc(cargaId).update({ estado: 'rechazado' });
      alert("Carga rechazada.");
      cargarCargasPendientes();
    } catch(e) {
      console.error(e);
      alert("Error al rechazar carga.");
    }
  }

  async function aprobarRetiro(retiroId, uid, monto) {
    try {
      const userRef = db.collection('users').doc(uid);
      const userDoc = await userRef.get();
      if(!userDoc.exists) {
        alert("Usuario no encontrado");
        return;
      }
      const saldoActual = userDoc.data().saldoARS || 0;
      if(monto > saldoActual) {
        alert("Saldo insuficiente para aprobar el retiro.");
        return;
      }
      await userRef.update({ saldoARS: saldoActual - monto });
      await db.collection('retiros').doc(retiroId).update({ estado: 'aprobado' });
      alert("Retiro aprobado y saldo descontado.");
      cargarRetirosPendientes();
    } catch(e) {
      console.error(e);
      alert("Error al aprobar retiro.");
    }
  }

  async function rechazarRetiro(retiroId) {
    try {
      await db.collection('retiros').doc(retiroId).update({ estado: 'rechazado' });
      alert("Retiro rechazado.");
      cargarRetirosPendientes();
    } catch(e) {
      console.error(e);
      alert("Error al rechazar retiro.");
    }
  }

  btnLogin.addEventListener("click", () => {
    loginError.textContent = "";
    const email = inputEmail.value.trim();
    const password = inputPassword.value.trim();

    if(!email || !password) {
      loginError.textContent = "Completa email y contraseña.";
      return;
    }

    auth.signInWithEmailAndPassword(email, password)
      .then(userCred => {
        if(userCred.user.uid !== UID_ADMIN) {
          loginError.textContent = "No tienes permisos de administrador.";
          auth.signOut();
        }
      })
      .catch(err => {
        loginError.textContent = err.message;
      });
  });

  btnLogout.addEventListener("click", () => {
    auth.signOut();
  });

  auth.onAuthStateChanged(user => {
    if(user && user.uid === UID_ADMIN) {
      modalLogin.style.display = "none";
      seccionCargas.style.display = "block";
      seccionRetiros.style.display = "block";
      btnLogout.style.display = "inline-block";
      cargarCargasPendientes();
      cargarRetirosPendientes();
    } else {
      modalLogin.style.display = "flex";
      seccionCargas.style.display = "none";
      seccionRetiros.style.display = "none";
      btnLogout.style.display = "none";
      inputPassword.value = "";
      inputEmail.value = "";
      loginError.textContent = "";
    }
  });

  // Filtros
  document.getElementById('btnFiltrarCargas').addEventListener('click', () => {
    const inicio = document.getElementById('fechaInicioCarga').valueAsDate;
    const fin = document.getElementById('fechaFinCarga').valueAsDate;
    const startTimestamp = inicio ? firebase.firestore.Timestamp.fromDate(inicio) : null;
    const endTimestamp = fin ? firebase.firestore.Timestamp.fromDate(fin) : null;
    cargarCargasPendientes(startTimestamp, endTimestamp);
  });

  document.getElementById('btnFiltrarRetiros').addEventListener('click', () => {
    const inicio = document.getElementById('fechaInicioRetiro').valueAsDate;
    const fin = document.getElementById('fechaFinRetiro').valueAsDate;
    const startTimestamp = inicio ? firebase.firestore.Timestamp.fromDate(inicio) : null;
    const endTimestamp = fin ? firebase.firestore.Timestamp.fromDate(fin) : null;
    cargarRetirosPendientes(startTimestamp, endTimestamp);
  });
</script>

</body>
</html>
