<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin LunaBet - Cargas y Retiros</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: white;
    margin: 0;
    padding: 20px;
  }
  h1 {
    color: #ff3333;
    margin-bottom: 10px;
  }
  section {
    margin-bottom: 40px;
    display: none; /* oculto por defecto, se muestra si está admin logueado */
  }
  label {
    margin-right: 10px;
  }
  input[type="date"] {
    margin-right: 20px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #444;
    padding: 10px;
    text-align: left;
  }
  th {
    background: #222;
  }
  button {
    background: #ff3333;
    border: none;
    color: white;
    padding: 6px 12px;
    margin-right: 6px;
    cursor: pointer;
    border-radius: 4px;
  }
  button:hover {
    background: #cc2929;
  }

  /* Modal login */
  #modalLogin {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  #modalLogin .modal-content {
    background: #222;
    padding: 30px;
    border-radius: 8px;
    width: 320px;
    box-sizing: border-box;
  }
  #modalLogin h2 {
    margin-top: 0;
    color: #ff3333;
    text-align: center;
  }
  #modalLogin input {
    width: 100%;
    padding: 10px;
    margin: 12px 0;
    border-radius: 6px;
    border: none;
    box-sizing: border-box;
  }
  #modalLogin button {
    width: 100%;
    padding: 12px;
    background: #ff3333;
    border: none;
    color: white;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
  }
  #modalLogin button:hover {
    background: #cc2929;
  }
  #loginError {
    color: #ff6666;
    text-align: center;
    min-height: 20px;
  }

  #btnLogout {
    background: #555;
    margin-top: 20px;
  }
  #btnLogout:hover {
    background: #333;
  }
</style>
</head>
<body>

<h1>Panel de Administración - LunaBet</h1>

<!-- Modal Login -->
<div id="modalLogin">
  <div class="modal-content">
    <h2>Iniciar sesión Admin</h2>
    <input type="email" id="inputEmail" placeholder="Correo electrónico" autocomplete="username" />
    <input type="password" id="inputPassword" placeholder="Contraseña" autocomplete="current-password" />
    <button id="btnLogin">Ingresar</button>
    <div id="loginError"></div>
  </div>
</div>

<!-- Secciones solo visibles si está logueado admin -->
<section id="seccionCargas">
  <h2>Cargas Pendientes</h2>
  <label>Desde: <input type="date" id="fechaInicioCarga" /></label>
  <label>Hasta: <input type="date" id="fechaFinCarga" /></label>
  <button id="btnFiltrarCargas">Filtrar</button>

  <table id="tablaCargas">
    <thead>
      <tr>
        <th>Email</th>
        <th>UID</th>
        <th>Monto</th>
        <th>Fecha</th>
        <th>Saldo Actual</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- Cargas cargadas dinámicamente -->
    </tbody>
  </table>
</section>

<section id="seccionRetiros">
  <h2>Retiros Pendientes</h2>
  <label>Desde: <input type="date" id="fechaInicioRetiro" /></label>
  <label>Hasta: <input type="date" id="fechaFinRetiro" /></label>
  <button id="btnFiltrarRetiros">Filtrar</button>

  <table id="tablaRetiros">
    <thead>
      <tr>
        <th>Email</th>
        <th>UID</th>
        <th>Monto</th>
        <th>Alias/CBU</th>
        <th>Fecha</th>
        <th>Saldo Actual</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- Retiros cargados dinámicamente -->
    </tbody>
  </table>
</section>

<button id="btnLogout" style="display:none;">Cerrar sesión</button>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBDWxn28oXn04--DMwkzqMq00g_W-OYJ3g",
    authDomain: "lunabet-73609.firebaseapp.com",
    projectId: "lunabet-73609",
    storageBucket: "lunabet-73609.appspot.com",
    messagingSenderId: "45582135337",
    appId: "1:45582135337:web:3cb9190e37827d9cc72c38",
    measurementId: "G-0XC4PX3HK9"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const UID_ADMIN = "keVqWPJpBvRZxtb5YjmXSPYM4Aa2";

  // Referencias DOM
  const modalLogin = document.getElementById("modalLogin");
  const inputEmail = document.getElementById("inputEmail");
  const inputPassword = document.getElementById("inputPassword");
  const btnLogin = document.getElementById("btnLogin");
  const loginError = document.getElementById("loginError");

  const seccionCargas = document.getElementById("seccionCargas");
  const seccionRetiros = document.getElementById("seccionRetiros");
  const btnLogout = document.getElementById("btnLogout");

  // Función para formatear fecha legible
  function formatearFecha(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    return date.toLocaleString();
  }

  // Cargar saldo del usuario para mostrar en tabla
  async function obtenerSaldoUsuario(uid) {
    try {
      const doc = await db.collection('users').doc(uid).get();
      if(doc.exists) {
        return doc.data().saldoARS || 0;
      } 
      return 0;
    } catch(e) {
      console.error("Error obtener saldo usuario:", e);
      return 0;
    }
  }

  // Cargar cargas pendientes con filtros
  async function cargarCargasPendientes(fechaInicio=null, fechaFin=null) {
    let query = db.collection('cargas').where('estado', '==', 'pendiente');

    if(fechaInicio) query = query.where('creado', '>=', fechaInicio);
    if(fechaFin) query = query.where('creado', '<=', fechaFin);

    query = query.orderBy('creado', 'desc');

    const snapshot = await query.get();

    const tbody = document.querySelector('#tablaCargas tbody');
    tbody.innerHTML = '';

    for(const doc of snapshot.docs) {
      const data = doc.data();
      const saldo = await obtenerSaldoUsuario(data.uid);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.email}</td>
        <td>${data.uid}</td>
        <td>$${data.monto}</td>
        <td>${formatearFecha(data.creado)}</td>
        <td>$${saldo}</td>
        <td>
          <button onclick="aprobarCarga('${doc.id}', '${data.uid}', ${data.monto})">Aprobar</button>
          <button onclick="rechazarCarga('${doc.id}')">Rechazar</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  // Cargar retiros pendientes con filtros
  async function cargarRetirosPendientes(fechaInicio=null, fechaFin=null) {
    let query = db.collection('retiros').where('estado', '==', 'pendiente');

    if(fechaInicio) query = query.where('creado', '>=', fechaInicio);
    if(fechaFin) query = query.where('creado', '<=', fechaFin);

    query = query.orderBy('creado', 'desc');

    const snapshot = await query.get();

    const tbody = document.querySelector('#tablaRetiros tbody');
    tbody.innerHTML = '';

    for(const doc of snapshot.docs) {
      const data = doc.data();
      const saldo = await obtenerSaldoUsuario(data.uid);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.email}</td>
        <td>${data.uid}</td>
        <td>$${data.monto}</td>
        <td>${data.alias}</td>
        <td>${formatearFecha(data.creado)}</td>
        <td>$${saldo}</td>
        <td>
          <button onclick="aprobarRetiro('${doc.id}', '${data.uid}', ${data.monto})">Aprobar</button>
          <button onclick="rechazarRetiro('${doc.id}')">Rechazar</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  // Función para aprobar carga
  async function aprobarCarga(cargaId, uid, monto) {
    try {
      const userRef = db.collection('users').doc(uid);
      const userDoc = await userRef.get();
      if(!userDoc.exists) {
        alert("Usuario no encontrado");
        return;
      }
      const saldoActual = userDoc.data().saldoARS || 0;
      await userRef.update({ saldoARS: saldoActual + monto });
      await db.collection('cargas').doc(cargaId).update({ estado: 'aprobado' });
      alert("Carga aprobada y saldo actualizado.");
      cargarCargasPendientes();
    } catch(e) {
      console.error(e);
      alert("Error al aprobar carga.");
    }
  }

  // Función para rechazar carga
  async function rechazarCarga(cargaId) {
    try {
      await db.collection('cargas').doc(cargaId).update({ estado: 'rechazado' });
      alert("Carga rechazada.");
      cargarCargasPendientes();
    } catch(e) {
      console.error(e);
      alert("Error al rechazar carga.");
    }
  }

  // Función para aprobar retiro
  async function aprobarRetiro(retiroId, uid, monto) {
    try {
      const userRef = db.collection('users').doc(uid);
      const userDoc = await userRef.get();
      if(!userDoc.exists) {
        alert("Usuario no encontrado");
        return;
      }
      const saldoActual = userDoc.data().saldoARS || 0;
      if(monto > saldoActual) {
        alert("Saldo insuficiente para aprobar el retiro.");
        return;
      }
      await userRef.update({ saldoARS: saldoActual - monto });
      await db.collection('retiros').doc(retiroId).update({ estado: 'aprobado' });
      alert("Retiro aprobado y saldo descontado.");
      cargarRetirosPendientes();
    } catch(e) {
      console.error(e);
      alert("Error al aprobar retiro.");
    }
  }

  // Función para rechazar retiro
  async function rechazarRetiro(retiroId) {
    try {
      await db.collection('retiros').doc(retiroId).update({ estado: 'rechazado' });
      alert("Retiro rechazado.");
      cargarRetirosPendientes();
    } catch(e) {
      console.error(e);
      alert("Error al rechazar retiro.");
    }
  }

  // Evento login
  btnLogin.addEventListener("click", () => {
    const email = inputEmail.value.trim();
    const password = inputPassword.value.trim();
    loginError.textContent = "";

    if(!email || !password){
      loginError.textContent = "Por favor ingresa email y contraseña.";
      return;
    }

    auth.signInWithEmailAndPassword(email, password)
      .then(userCred => {
        if(userCred.user.uid !== UID_ADMIN){
          loginError.textContent = "No tienes permisos de administrador.";
          auth.signOut();
        }
      })
      .catch(err => {
        loginError.textContent = err.message;
      });
  });

  // Evento logout
  btnLogout.addEventListener("click", () => {
    auth.signOut();
  });

  // Control de estado de autenticación
  auth.onAuthStateChanged(user => {
    if(user){
      if(user.uid === UID_ADMIN){
        // Admin logueado: mostrar panel y ocultar modal
        modalLogin.style.display = "none";
        seccionCargas.style.display = "block";
        seccionRetiros.style.display = "block";
        btnLogout.style.display = "inline-block";
        cargarCargasPendientes();
        cargarRetirosPendientes();
      } else {
        // Usuario no admin: cerrar sesión y mostrar modal
        auth.signOut();
        modalLogin.style.display = "flex";
        seccionCargas.style.display = "none";
        seccionRetiros.style.display = "none";
        btnLogout.style.display = "none";
        inputEmail.value = "";
        inputPassword.value = "";
        loginError.textContent = "";
      }
    } else {
      // No hay usuario logueado: mostrar modal
      modalLogin.style.display = "flex";
      seccionCargas.style.display = "none";
      seccionRetiros.style.display = "none";
      btnLogout.style.display = "none";
      inputEmail.value = "";
      inputPassword.value = "";
      loginError.textContent = "";
    }
  });

  // Filtros de fecha cargas
  document.getElementById('btnFiltrarCargas').addEventListener('click', () => {
    const inicio = document.getElementById('fechaInicioCarga').valueAsDate;
    const fin = document.getElementById('fechaFinCarga').valueAsDate;

    const startTimestamp = inicio ? firebase.firestore.Timestamp.fromDate(inicio) : null;
    const endTimestamp = fin ? firebase.firestore.Timestamp.fromDate(fin) : null;

    cargarCargasPendientes(startTimestamp, endTimestamp);
  });

  // Filtros de fecha retiros
  document.getElementById('btnFiltrarRetiros').addEventListener('click', () => {
    const inicio = document.getElementById('fechaInicioRetiro').valueAsDate;
    const fin = document.getElementById('fechaFinRetiro').valueAsDate;

    const startTimestamp = inicio ? firebase.firestore.Timestamp.fromDate(inicio) : null;
    const endTimestamp = fin ? firebase.firestore.Timestamp.fromDate(fin) : null;

    cargarRetirosPendientes(startTimestamp, endTimestamp);
  });

</script>

</body>
</html>
