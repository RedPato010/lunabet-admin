<!-- Mismo HTML que me pasaste, sin cambios... -->
<!-- ...hasta llegar al <script> -->

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBDWxn28oXn04--DMwkzqMq00g_W-OYJ3g",
    authDomain: "lunabet-73609.firebaseapp.com",
    projectId: "lunabet-73609",
    storageBucket: "lunabet-73609.appspot.com",
    messagingSenderId: "45582135337",
    appId: "1:45582135337:web:3cb9190e37827d9cc72c38",
    measurementId: "G-0XC4PX3HK9"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const UID_ADMIN = "jtwsDFEpIUOZ7VGeBlFPwBK7JIm1";

  const modalLogin = document.getElementById("modalLogin");
  const inputEmail = document.getElementById("inputEmail");
  const inputPassword = document.getElementById("inputPassword");
  const btnLogin = document.getElementById("btnLogin");
  const loginError = document.getElementById("loginError");

  const seccionCargas = document.getElementById("seccionCargas");
  const seccionRetiros = document.getElementById("seccionRetiros");
  const btnLogout = document.getElementById("btnLogout");

  function formatearFecha(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    return date.toLocaleString();
  }

  async function obtenerSaldoUsuario(uid) {
    try {
      const doc = await db.collection('users').doc(uid).get();
      if (doc.exists) return doc.data().saldoARS || 0;
      return 0;
    } catch (e) {
      console.error("Error obtener saldo:", e);
      return 0;
    }
  }

  function cargarCargasPendientesRealtime() {
    db.collection('cargas')
      .where('estado', '==', 'pendiente')
      .orderBy('creado', 'desc')
      .onSnapshot(async snapshot => {
        const tbody = document.querySelector('#tablaCargas tbody');
        tbody.innerHTML = '';
        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="6">Sin cargas pendientes</td></tr>';
          return;
        }

        for (const doc of snapshot.docs) {
          const data = doc.data();
          console.log("Carga recibida:", data); // <-- DEBUG
          const saldo = await obtenerSaldoUsuario(data.uid);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${data.email}</td>
            <td>${data.uid}</td>
            <td>$${data.monto}</td>
            <td>${formatearFecha(data.creado)}</td>
            <td>$${saldo}</td>
            <td>
              <button onclick="aprobarCarga('${doc.id}', '${data.uid}', ${data.monto})">Aprobar</button>
              <button onclick="rechazarCarga('${doc.id}')">Rechazar</button>
            </td>`;
          tbody.appendChild(tr);
        }
      });
  }

  function cargarRetirosPendientesRealtime() {
    db.collection('retiros')
      .where('estado', '==', 'pendiente')
      .orderBy('creado', 'desc')
      .onSnapshot(async snapshot => {
        const tbody = document.querySelector('#tablaRetiros tbody');
        tbody.innerHTML = '';
        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="7">Sin retiros pendientes</td></tr>';
          return;
        }

        for (const doc of snapshot.docs) {
          const data = doc.data();
          console.log("Retiro recibido:", data); // <-- DEBUG
          const saldo = await obtenerSaldoUsuario(data.uid);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${data.email}</td>
            <td>${data.uid}</td>
            <td>$${data.monto}</td>
            <td>${data.alias}</td>
            <td>${formatearFecha(data.creado)}</td>
            <td>$${saldo}</td>
            <td>
              <button onclick="aprobarRetiro('${doc.id}', '${data.uid}', ${data.monto})">Aprobar</button>
              <button onclick="rechazarRetiro('${doc.id}')">Rechazar</button>
            </td>`;
          tbody.appendChild(tr);
        }
      });
  }

  async function aprobarCarga(cargaId, uid, monto) {
    try {
      const userRef = db.collection('users').doc(uid);
      const userDoc = await userRef.get();
      const saldo = userDoc.data().saldoARS || 0;
      await userRef.update({ saldoARS: saldo + monto });
      await db.collection('cargas').doc(cargaId).update({ estado: 'aprobado' });
    } catch (e) {
      alert("Error aprobando carga: " + e.message);
    }
  }

  async function rechazarCarga(cargaId) {
    try {
      await db.collection('cargas').doc(cargaId).update({ estado: 'rechazado' });
    } catch (e) {
      alert("Error rechazando carga: " + e.message);
    }
  }

  async function aprobarRetiro(retiroId, uid, monto) {
    try {
      const userRef = db.collection('users').doc(uid);
      const userDoc = await userRef.get();
      const saldo = userDoc.data().saldoARS || 0;
      if (monto > saldo) return alert("Saldo insuficiente");
      await userRef.update({ saldoARS: saldo - monto });
      await db.collection('retiros').doc(retiroId).update({ estado: 'aprobado' });
    } catch (e) {
      alert("Error aprobando retiro: " + e.message);
    }
  }

  async function rechazarRetiro(retiroId) {
    try {
      await db.collection('retiros').doc(retiroId).update({ estado: 'rechazado' });
    } catch (e) {
      alert("Error rechazando retiro: " + e.message);
    }
  }

  btnLogin.addEventListener("click", () => {
    const email = inputEmail.value.trim();
    const password = inputPassword.value.trim();
    loginError.textContent = "";
    if (!email || !password) return loginError.textContent = "Ingrese correo y contraseÃ±a";

    auth.signInWithEmailAndPassword(email, password)
      .then(userCred => {
        if (userCred.user.uid !== UID_ADMIN) {
          auth.signOut();
          loginError.textContent = "No tienes permisos de administrador.";
        }
      })
      .catch(err => loginError.textContent = err.message);
  });

  btnLogout.addEventListener("click", () => auth.signOut());

  auth.onAuthStateChanged(user => {
    const isAdmin = user && user.uid === UID_ADMIN;
    modalLogin.style.display = isAdmin ? "none" : "flex";
    seccionCargas.style.display = isAdmin ? "block" : "none";
    seccionRetiros.style.display = isAdmin ? "block" : "none";
    btnLogout.style.display = isAdmin ? "inline-block" : "none";

    if (isAdmin) {
      cargarCargasPendientesRealtime();
      cargarRetirosPendientesRealtime();
    }
  });
</script>
